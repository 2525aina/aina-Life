rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // ヘルパー関数
    // ============================================
    
    // 認証済みか
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // 自分自身か
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // 共通フィールドの検証
    function hasValidTimestamps() {
      return request.resource.data.updatedAt == request.time;
    }
    
    function hasValidCreator() {
      return request.resource.data.createdBy == request.auth.uid;
    }
    
    function hasValidUpdater() {
      return request.resource.data.updatedBy == request.auth.uid;
    }
    
    // ペット作成者か
    function isPetCreator(petId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/pets/$(petId)) &&
             get(/databases/$(database)/documents/pets/$(petId)).data.createdBy == request.auth.uid;
    }
    // ペットメンバーか（サブコレクションに自分のIDのドキュメントがあるか）
    function isPetMember(petId) {
      return isAuthenticated() && exists(/databases/$(database)/documents/pets/$(petId)/members/$(request.auth.uid));
    }

    // ============================================
    // users コレクション
    // ============================================
    match /users/{userId} {
      // 読み取り: 認証済みユーザー
      allow read: if isAuthenticated();
      
      // 作成: 自分自身のみ
      allow create: if isOwner(userId);
      
      // 更新: 自分自身のみ
      allow update: if isOwner(userId);
      
      // 削除: 禁止
      allow delete: if false;
    }
    
    // ============================================
    // pets コレクション
    // ============================================
    match /pets/{petId} {
      // 読み取り: 作成者、またはメンバー
      // memberUids配列ではなく、サブコレクションの存在確認を行う
      allow read: if isAuthenticated() && (
        exists(/databases/$(database)/documents/pets/$(petId)/members/$(request.auth.uid)) ||
        resource == null ||
        ('createdBy' in resource.data && resource.data.createdBy == request.auth.uid)
      );
      
      // 作成: 認証済みユーザー
      allow create: if isAuthenticated() && hasValidCreator() && hasValidUpdater();
      
      // 更新: メンバーであれば許可（本来はroleチェックすべきだが、一旦メンバーならOKとする）
      allow update: if isPetMember(petId);
      
      // 削除: 作成者のみ
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
      
      // ----------------------------------------
      // members サブコレクション
      // ----------------------------------------
      match /members/{memberId} {
        // 読み取り: 認証済みユーザー（ペット作成者か、自分宛ての招待）
        allow read: if isAuthenticated();
        
        // 作成: ペット作成者、または自分自身の登録
        allow create: if isAuthenticated() && (
          // 自分自身を owner として登録（ペット作成時）
          request.resource.data.userId == request.auth.uid ||
          // ペット作成者による招待
          isPetCreator(petId)
        );
        
        // 更新: ペット作成者、または招待承諾時の自分自身
        allow update: if isAuthenticated() && (
          // 招待承諾
          (resource.data.inviteEmail == request.auth.token.email.lower() &&
           resource.data.status == 'pending') ||
          // ペット作成者による更新
          isPetCreator(petId)
        );
        
        // 削除: ペット作成者、または自分自身（脱退・辞退）
        allow delete: if isAuthenticated() && (
          isPetCreator(petId) ||
          resource.data.userId == request.auth.uid ||
          resource.data.inviteEmail == request.auth.token.email.lower()
        );
      }
      
      // ----------------------------------------
      // entries サブコレクション
      // ----------------------------------------

      match /entries/{entryId} {
        allow read: if isPetMember(petId);
        allow create: if isPetMember(petId) && hasValidCreator() && hasValidUpdater();
        allow update: if isPetMember(petId) && hasValidUpdater();
        allow delete: if isPetMember(petId);
      }
      
      // ----------------------------------------
      // weights サブコレクション
      // ----------------------------------------
      match /weights/{weightId} {
        allow read: if isPetMember(petId);
        allow create: if isPetMember(petId) && hasValidCreator() && hasValidUpdater();
        allow update: if isPetMember(petId) && hasValidUpdater();
        allow delete: if isPetMember(petId);
      }
      
      // ----------------------------------------
      // tasks サブコレクション
      // ----------------------------------------
      match /tasks/{taskId} {
        allow read: if isPetMember(petId);
        allow create: if isPetMember(petId) && hasValidCreator() && hasValidUpdater();
        allow update: if isPetMember(petId) && hasValidUpdater();
        allow delete: if isPetMember(petId);
      }
      
      // ----------------------------------------
      // friends サブコレクション
      // ----------------------------------------
      match /friends/{friendId} {
        allow read: if isPetMember(petId);
        allow create, update: if isPetMember(petId);
        allow delete: if isPetMember(petId);
        
        match /encounters/{encounterId} {
          allow read, write: if isPetMember(petId);
        }
      }
    }
    
    // ============================================
    // collectionGroup クエリ用
    // ============================================
    match /{path=**}/members/{memberId} {
      // 自分宛ての招待を検索するため
      // 暫定対応：招待が表示されない問題をデバッグするため、読み取り制限を緩和
      // クライアント側で where('inviteEmail', ...) でフィルタリングしているため、
      // 画面上には自分の招待のみが表示されます。
      allow read: if isAuthenticated();
    }
  }
}
