rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // 既存の広範なルール (必要に応じて後で細分化)
    match /{document=**} {
      allow read, write: if request.auth != null;
    }

    // 'members' コレクショングループに対する明示的なルール
    // 認証されており、かつドキュメントの inviteEmail が自身のメールアドレスと一致する場合に読み取りを許可
    match /{path=**}/members/{memberId} {
      allow read: if request.auth != null && resource.data.inviteEmail == request.auth.token.email;
    }

    // プレゼンスコレクションのルール
    match /presence/{userId} {
      // ユーザーは自身のプレゼンスドキュメントのみ作成・更新可能
      allow create, update: if request.auth != null && request.auth.uid == userId;
      // 全ての認証済みユーザーは他のユーザーのプレゼンスドキュメントを読み取り可能
      allow read: if request.auth != null;
      // プレゼンスドキュメントの削除は許可しない（自動的に期限切れになるか、更新で対応）
      allow delete: if false;
    }
  }
}