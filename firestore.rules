rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    match /pets/{petId} {
      // Allow read if user is owner (on pet doc) or a member (in subcollection)
      allow read: if request.auth != null && (
        resource.data.ownerId == request.auth.uid || 
        exists(/databases/$(database)/documents/pets/$(petId)/members/$(request.auth.uid))
      );
      // Allow create if authenticated
      allow create: if request.auth != null;
      // Allow update/delete if owner (on pet doc) or 'owner' role in members
      allow update, delete: if request.auth != null && (
        resource.data.ownerId == request.auth.uid || 
        isOwnerInMembers(petId)
      );

      match /entries/{entryId} {
        allow read, write: if request.auth != null && canAccessPet(petId);
      }

      match /weights/{weightId} {
        allow read, write: if request.auth != null && canAccessPet(petId);
      }

      match /members/{memberId} {
        // 読み取り: ペットにアクセスできるメンバー
        allow read: if request.auth != null && (
          exists(/databases/$(database)/documents/pets/$(petId)/members/$(request.auth.uid)) ||
          (exists(/databases/$(database)/documents/pets/$(petId)) && 
           get(/databases/$(database)/documents/pets/$(petId)).data.ownerId == request.auth.uid)
        );
        // 作成: ペット作成時にオーナーがメンバーを追加するケース
        // request.resource.data.userId がリクエストしているユーザーと一致すればOK
        allow create: if request.auth != null && (
          request.resource.data.userId == request.auth.uid ||
          (exists(/databases/$(database)/documents/pets/$(petId)) && 
           get(/databases/$(database)/documents/pets/$(petId)).data.ownerId == request.auth.uid)
        );
        // 更新・削除: ペットのオーナーのみ
        allow update, delete: if request.auth != null && (
          (exists(/databases/$(database)/documents/pets/$(petId)) && 
           get(/databases/$(database)/documents/pets/$(petId)).data.ownerId == request.auth.uid) ||
          isOwnerInMembers(petId)
        );
      }

      match /friends/{friendId} {
        allow read, write: if request.auth != null && canAccessPet(petId);
        match /encounters/{encounterId} {
          allow read, write: if request.auth != null && canAccessPet(petId);
        }
      }
    }

    match /{path=**}/members/{memberId} {
      // 自分宛の招待（inviteEmail）または自分がメンバー（userId）の場合に読み取り可能
      // 注意: inviteEmailは小文字で保存されているので、token.emailも小文字化して比較
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid || 
        resource.data.inviteEmail == request.auth.token.email.lower()
      );
    }

    // Helper functions
    function canAccessPet(petId) {
      // Check parent pet ownerId OR existence in members
      let pet = get(/databases/$(database)/documents/pets/$(petId));
      return pet.data.ownerId == request.auth.uid || 
             exists(/databases/$(database)/documents/pets/$(petId)/members/$(request.auth.uid));
    }

    function isOwnerInMembers(petId) {
      let member = get(/databases/$(database)/documents/pets/$(petId)/members/$(request.auth.uid));
      return member != null && member.data.role == 'owner';
    }
  }
}
